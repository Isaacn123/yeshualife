const closebtn=document.getElementById('btn-close').addEventListener('click',function(){const pendingModal=new bootstrap.Modal(document.getElementById('pendingModalLong'));pendingModal.hide();document.querySelector('.modal-backdrop')?.remove();});var modalProgressBar=document.getElementById('modalProgressBar');var btnCancel=document.getElementById('cancelbtn');var btnSuccess=document.getElementById('successbtn');var statusMessage=document.getElementById('statusMessage');var progress=0;document.addEventListener("DOMContentLoaded",function(){const form=document.getElementById('mtn-payment');function updateModalProgress(){if(progress<100){progress+=5;modalProgressBar.style.width=progress+'%';modalProgressBar.setAttribute('aria-valuenow',progress);modalProgressBar.innerHTML=progress+'%';}
if(progress===100){statusMessage.innerHTML="Transaction Successful!. Thank you for your donation!";btnSuccess.removeAttribute('disabled');}}
function showModalAndStartProgress(){push.show();var intervalId=setInterval(updateModalProgress,600);setTimeout(function(){clearInterval(intervalId);alert("Payment status check timed out after 60 seconds.");modalpush.hide();},60000);}
var mtnbutton=document.getElementById("my-button-mtn");const modalElement=document.getElementById('mtnModal');current_user=document.getElementById('donorName').value;var formData=JSON.parse(localStorage.getItem('formData'))||{};console.log("PASSED-DATA:--::",formData);const modalPendingElement=document.getElementById('pendingModalLong');const modalSuccessElement=document.getElementById('exampleModalPush');const modal=new bootstrap.Modal(modalElement);const modalPending=new bootstrap.Modal(modalPendingElement);const modalSuccess=new bootstrap.Modal(modalSuccessElement);const btnSuccess=document.getElementById('successbtn');var bsModal=new bootstrap.Modal(document.getElementById('myDialog'));mtnbutton.addEventListener('click',function(event){event.preventDefault();number=document.getElementById("phoneid").value;msgPayment=document.getElementById("message").value;currency=document.getElementById('currency').value
console.log("MASS---",msgPayment)
console.log("number:::",number);console.log("PASSED-DATA::",formData);if(number===null||number.trim()===''){alert("Phone number can't be blank!")
return false;}
else if(currency===''||currency==='Choose'){alert("Please select a valid currency.");return false;}else if(number!==''&&!number.match(/^\d{10,15}$/)){alert('Please enter a valid number.');return false;}else{if(number.startsWith('0')){number='256'+number.slice(1);}
console.log("MASS",msgPayment)
var phoneNumber=document.getElementById('phoneid').value.startsWith('0')?'256'+document.getElementById('phoneid').value.substring(1):document.getElementById('phoneid').value;const fullname=document.getElementById('fullname');var mtn_payment={amount:document.getElementById('donationAmount').value,currency:currency,fullname:document.getElementById('donorName').value,message:document.getElementById('message').value,phone:phoneNumber,}
data={"amount":mtn_payment['amount'],"currency":mtn_payment["currency"],"txt_ref":"some_ref_value","phone_number":mtn_payment["phone"],"payermessage":mtn_payment["message"],}
console.log("Data:MTN--M",data);const mtnModalInstance=bootstrap.Modal.getInstance(document.getElementById('mtnModal'));mtnModalInstance.hide();setTimeout(()=>{const pendingModal=new bootstrap.Modal(document.getElementById('pendingModalLong'));pendingModal.show();},500);apiCall(data)}});let intervalId;function apiCall(data){const url="https://pay.yeshualifeug.com/pay";fetch(url,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({"amount":data['amount'],"currency":data['currency'],"txt_ref":data['txt_ref'],"phone_number":data['phone_number'],"payermessage":data['payermessage']})}).then(response=>{if(!response.ok){return Promise.reject("API call failed with status: "+response.status);}
return response.json();}).then(data=>{console.log('API Response:',data);if(data.status==='SUCCESSFUL'){}else if(data.status==='FAILED'){alert('Payment failed: '+data.message);console.log('Payment failed:',data.message);}else if(data.status==='PENDING'){console.log("Payment is pending, please wait...")
console.log("Response: Data",data)
console.log("Ref",data.ref);pollPaymentStatus(data.ref);}}).catch(error=>{console.error('Error calling /pay API:',error);alert('There was an error processing your payment.');});}
function pollPaymentStatus(ref){const intervalId=setInterval(function(){fetch(`https://pay.yeshualifeug.com/status/${ref}`).then(response=>response.json()).then(data=>{console.log('STATUS-PAY:',data.status);if(data.status==='SUCCESSFUL'){modalPending.hide();const peningModalInstance=bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));peningModalInstance.hide()
setTimeout(()=>{modalSuccess.show();},500);console.log("Payment processed successfully!")
clearInterval(intervalId);}else if(data.status==='FAILED'){modalPending.hide();clearInterval(intervalId);alert("Payment failed: "+data.message);}else if(data.status==='PENDING'){console.log("Payment is still pending...");modalPending.show()}}).catch(error=>{console.error('Error polling payment status:',error);});},5000);setTimeout(function(){clearInterval(intervalId);const pendingModal=bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));if(pendingModal)pendingModal.hide();const showsuccess=bootstrap.Modal.getInstance(document.getElementById('exampleModalPush'));if(showsuccess)showsuccess.hide();setTimeout(()=>{alert("Payment status check timed out after 60 seconds.");},300);modalPending.hide();},50000);}
const phoneInput=document.getElementById('phoneid');const statusIcon=document.getElementById('phone-status');const statusIconName=document.getElementById('phone-status-name');const userinfo_name=document.getElementById('fullname');const paydonation=document.getElementById('my-button-mtn');phoneInput.addEventListener('input',async function(){checkNumberAndCallApi(phoneInput.value)})
function checkNumberAndCallApi(phone){console.log("PHONE",phone);const cleaned=phone.replace(/\D/g,'');console.log("PHONE-clean",cleaned);let trimmed=cleaned;if(cleaned.startsWith('0')){trimmed=cleaned.slice(1)}else if(cleaned.startsWith('256')){trimmed=cleaned.slice(3)}
if(trimmed.length===9){statusIcon.innerHTML='<span class="loader"></span>';console.log("--NUM.length",trimmed.length)
fetch(`https://pay.yeshualifeug.com/userinfo`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phonenumber:'256'+trimmed})}).then(res=>res.json()).then(data=>{console.log("retturned..");console.log(data);if(data){statusIcon.textContent='✅';statusIconName.textContent='✅';const name=data['family_name']+" "+data['given_name'];document.getElementById('donorName').value=name;paydonation.disabled=false;console.log("names",name)}else{statusIcon.textContent='❌';}}).catch(err=>{statusIcon.textContent='⚠️';statusIconName.textContent='⚠️';console.error('API error:',err)});}else{statusIcon.textContent='';}}});;