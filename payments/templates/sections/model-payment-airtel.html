<!-- Modal -->
{% load static %}
{% load wagtailcore_tags wagtailimages_tags%}
{% block extra_css %}
<link href="{% static 'css/payment.css'%}" rel="stylesheet">
{% endblock  %}

<div class="modal fade" id="airtelModal" tabindex="-1" aria-labelledby="airtelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="airtelModalLabel">AIRTEL PAY</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="container bg-light d-md-flex align-items-center justify-content-center p-3">
                <div class="card box2 shadow-sm m-0 ">
                    <div class="d-flex align-items-center justify-content-between p-md-5 p-4 airtel-background"> <span
                            class="h5 fw-bold m-0 text-white">AIRTEL PAYMENT</span>
                        <div class="btn">
                            <img src="{% static 'images/airtel_money.jpeg'%}"  alt="" height="60" width="60" srcset="">
                        </div>
                    </div>
                
                    <form action="" id="payform" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex flex-column px-md-5 px-4 mb-4"> <span>Donor Name</span>
                                    <div class="inputWithIcon"> 
                                        <input id="airtel-fullname"  class="form-control fw-light" type="text"
                                        value="Guest User" hidden>

                                        <input id="airtel-donorName"  class="form-control fw-light" type="text"
                                            value="" disabled>
                                   <span id="airtel-phone-status-name" style="margin-left: 10px; padding-bottom:5px;">
                                   </span>
                                        </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column ps-md-5 px-md-0 px-4 mb-4"> <span>Donation<span
                                            class="ps-1">Amount</span></span>
                                    <div class="inputWithIcon">
                                <input id="airtel-donationAmount" type="text" class="form-control" placeholder="500" disabled> <span
                                            class="fas fa-money-bill"></span> </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column pe-md-5 px-md-0 px-4 mb-4"> <span>Currency</span>
                                    <div class="inputWithIcon"> 
                                     <input id="airtel-currency" type="text" value="UGX" disabled>
                                        <span
                                            class="fas fa-lock">
                                        </span></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-column px-md-5 px-4 mb-4"> <span>Enter Number:</span>
                                    <div class="inputWithIcon">
                                        <input id="airtel-pay-phoneid" class="form-control text-uppercase" type="text"
                                            placeholder="anumber (0754-345-343)" name="airtel-pay-phone"> <span class="far fa-phone"></span>
                                            <span id="airtel-phone-status" style="padding-top: 5px;"></span> 
                                            <input id="airtel-message"  class="form-control fw-light" type="text"
                                            value="karamoja seed" hidden>
                                        </div>
                                </div>
                            </div>
                            <div class="col-12 px-md-5 px-4 mt-3">
                                <button id="airtel-pay-button" class="btn btn-primary w-100" type="submit" disabled>Pay UG5X 500.00</button>
                            </div>
                        </div>
                    </form>
                  
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  {% block extra_js %}
  <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById("payform");
            var airtelbtn = document.getElementById("airtel-pay-button");
            
            // Fix backdrop issue for Airtel modal close buttons
            const airtelModal = document.getElementById('airtelModal');
            const airtelCloseButtons = airtelModal.querySelectorAll('[data-bs-dismiss="modal"]');
            
            airtelCloseButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove any lingering backdrop
                    setTimeout(() => {
                        document.querySelector('.modal-backdrop')?.remove();
                    }, 300);
                });
            });
            
            // Also handle when modal is hidden programmatically
            airtelModal.addEventListener('hidden.bs.modal', function() {
                document.querySelector('.modal-backdrop')?.remove();
            });
            
            // Add independent Airtel button handler like MTN has
            var airtelModalButton = document.getElementById("openAirtelModalButton");
            if(airtelModalButton) {
                airtelModalButton.addEventListener('click', function() {
                    // Get current form data from main form
                    var currentFormData = {
                        message: document.getElementsByName('message')[0]?.value || '',
                        donationAmount: document.getElementsByName('amount')[0]?.value || '',
                        currency: 'UGX',
                        name: document.getElementsByName('fullname')[0]?.value || ''
                    };
                    
                    console.log("Airtel button clicked, form data:", currentFormData);
                    
                    if(!currentFormData.donationAmount) {
                        alert('Please enter a donation amount first!');
                        return;
                    }
                    
                    // Populate Airtel modal fields
                    document.getElementById('airtel-pay-phoneid').value = '';
                    document.getElementById('airtel-donorName').value = currentFormData.name;
                    document.getElementById('airtel-donationAmount').value = currentFormData.donationAmount;
                    document.getElementById('airtel-currency').value = currentFormData.currency;
                    document.getElementById('airtel-fullname').value = currentFormData.name;
                    document.getElementById('airtel-message').value = currentFormData.message;
                    document.getElementById('airtel-pay-button').textContent = 'Give ' + Number(currentFormData.donationAmount).toLocaleString() + ' UGX';
                    
                    // Store in localStorage for consistency
                    localStorage.setItem('formData', JSON.stringify(currentFormData));
                    
                    // Open the Airtel modal
                    const airtelModal = new bootstrap.Modal(document.getElementById('airtelModal'));
                    airtelModal.show();
                });
            }
            
            // Get form data from localStorage like MTN modal does
            var formData = JSON.parse(localStorage.getItem('formData')) || {};
            console.log("AIRTEL-PASSED-DATA::", formData);
            
            // Add phone number validation and user info fetching for Airtel
            const airtelStatusIcon = document.getElementById('airtel-phone-status');
            const airtelStatusIconName = document.getElementById('airtel-phone-status-name');
            const airtelPayButton = document.getElementById('airtel-pay-button');
            const airtelPhoneInput = document.getElementById('airtel-pay-phoneid');
            
            function checkAirtelNumberAndCallApi(phone) {
                console.log("AIRTEL-PHONE input:", phone);
                const cleaned = phone.replace(/\D/g, '');
                console.log("AIRTEL-PHONE after removing non-digits:", cleaned);
                
                let trimmed = cleaned;
                if(cleaned.startsWith('0')) {
                    console.log("AIRTEL: Removing leading 0");
                    trimmed = cleaned.slice(1);
                } else if(cleaned.startsWith('256')) {
                    console.log("AIRTEL: Removing 256 prefix");
                    trimmed = cleaned.slice(3);
                }
                console.log("AIRTEL-PHONE final trimmed:", trimmed);
                
                if(trimmed.length === 9) {
                    airtelStatusIcon.innerHTML = '<span class="loader"></span>';
                    console.log("--AIRTEL-NUM.length", trimmed.length);
                    console.log("--AIRTEL-SENDING to API:", trimmed);
                    
                    const requestBody = {
                        phonenumber: trimmed
                    };
                    console.log("--AIRTEL-REQUEST-BODY:", JSON.stringify(requestBody));
                    
                    fetch(`https://pay.yeshualifeug.com/airtel-userinfo`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(res => res.json())
                    .then(response => {
                        console.log("AIRTEL returned..");
                        console.log(response);
                        if(response && response.data && response.status && response.status.success) {
                            airtelStatusIcon.textContent = '✅';
                            airtelStatusIconName.textContent = '✅';
                            const userData = response.data;
                            const name = userData['first_name'] + " " + userData['last_name'];
                            document.getElementById('airtel-donorName').value = name;
                            airtelPayButton.disabled = false;
                            console.log("AIRTEL names", name);
                        } else {
                            airtelStatusIcon.textContent = '❌';
                            console.log("AIRTEL: User not found or API error");
                        }
                    })
                    .catch(err => {
                        airtelStatusIcon.textContent = '⚠️';
                        airtelStatusIconName.textContent = '⚠️';
                        console.error('AIRTEL API error:', err);
                    });
                } else {
                    airtelStatusIcon.textContent = '';
                }
            }
            
            // Add input event listener to Airtel phone field
            if(airtelPhoneInput) {
                airtelPhoneInput.addEventListener('input', async function() {
                    checkAirtelNumberAndCallApi(airtelPhoneInput.value);
                });
            }
            
            // Add phone number input guard
            const phoneInput = document.getElementById('airtel-pay-phoneid');
            if(phoneInput) {
                phoneInput.addEventListener('input', function() {
                    let value = this.value;
                    
                    // Remove all non-digit characters
                    value = value.replace(/\D/g, '');
                    
                    // Remove common prefixes
                    if(value.startsWith('256')) {
                        value = value.substring(3); // Remove 256
                    } else if(value.startsWith('0')) {
                        value = value.substring(1); // Remove leading 0
                    }
                    // Limit to 9 digits max (for 7XX or 9XX format)
                    if(value.length > 9) {
                        value = value.substring(0, 9);
                    }
                    
                    this.value = value;
                });
            }

            airtelbtn.addEventListener('click', function(event){
            event.preventDefault();
        
            var rawNumber = document.getElementById('airtel-pay-phoneid').value;
            
            // Clean the phone number before processing (UI remains unchanged)
            function cleanPhoneNumber(phoneNumber) {
                let cleaned = phoneNumber;
                
                // Remove all non-digit characters
                cleaned = cleaned.replace(/\D/g, '');
                
                // Remove common prefixes
                if(cleaned.startsWith('256')) {
                    cleaned = cleaned.substring(3); // Remove 256
                } else if(cleaned.startsWith('0')) {
                    cleaned = cleaned.substring(1); // Remove leading 0
                }
                
                // Limit to 9 digits max (for 7XX or 9XX format)
                if(cleaned.length > 9) {
                    cleaned = cleaned.substring(0, 9);
                }
                
                return cleaned;
            }
            
            var number = cleanPhoneNumber(rawNumber);
            msgPayment = document.getElementById("airtel-message").value;
            console.log("Raw number input:", rawNumber);
            console.log("Cleaned number:", number);
            if(number === null || number.trim() === '' ){
                alert("Phone number can't be blank!")
                return false;
            }else if (number.length < 9){
                alert('Please enter a valid number with at least 9 digits.'); 
                return false; 
            }else{
                    // If the number is valid, allow the form to be submitted
                    //form.submit();
                   



                    console.log("MASS",msgPayment)

                    var airtel_payment = {
                        amount: document.getElementById('airtel-donationAmount').value,
                        currency: document.getElementById('airtel-currency').value,
                        fullname: document.getElementById('airtel-donorName').value,
                        message: document.getElementById('airtel-message').value,
                        phone: document.getElementById('airtel-pay-phoneid').value,
                       }
                        console.log("Data:AIRTEL", airtel_payment);
                        
                        // Hide Airtel modal and show pending modal like MTN
                        const airtelModalInstance = bootstrap.Modal.getInstance(document.getElementById('airtelModal'));
                        airtelModalInstance.hide();
                        
                        setTimeout(() => {
                            const pendingModal = new bootstrap.Modal(document.getElementById('pendingModalLong'));
                            pendingModal.show();
                        }, 800); // matches MTN timing
                        
                        airtelCallApi(airtel_payment);
            }
        
           }); 

         
         
         
           function airtelCallApi(data){
  const url = "https://pay.yeshualifeug.com/airtel-pay";

  fetch(url,
    {
       method:"POST",
       headers:{
         'Content-Type': 'application/json'
       },
       body:JSON.stringify({
      
          "amount": data['amount'] ,
          "currency": data['currency'],
          "txt_ref": "airtel_ref_value",
          "phone_number": data['phone'],
          "payermessage": data['message']
        })
    }
  ).then( response =>{
    if(!response.ok){
        return Promise.reject("API call failed with status: " + response.status);
    }
    return response.json();

  }).then(data =>{

    console.log('AIRTEL API Response:', data);

    if (data.status === 'TS') {
        // TS = Transaction Success
        const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
        pendingModalInstance.hide();
        
        setTimeout(() => {
            const successModal = new bootstrap.Modal(document.getElementById('exampleModalPush'));
            successModal.show();
        }, 500);
        
        console.log('AIRTEL Payment processed successfully! (TS)');
    } else if (data.status === 'TF' || data.status === 'TE') {
        // TF = Transaction Failed, TE = Transaction Expired
        const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
        pendingModalInstance.hide();
        
        alert('AIRTEL Payment failed: ' + (data.message || (data.status === 'TF' ? 'Transaction Failed' : 'Transaction Expired')));
        console.log('AIRTEL Payment failed:', data.status, data.message);
    } else if (data.status === 'TIP') {
        // TIP = Transaction in Progress
        console.log("AIRTEL Payment is in progress (TIP), please wait...")
        console.log("AIRTEL Response: Data", data)
    
        console.log("AIRTEL Ref", data.ref);
        // Start polling for payment status
        pollAirtelPaymentStatus(data.ref);
    } else if (data.status === 'TA') {
        // TA = Transaction Ambiguous - needs polling
        console.log("AIRTEL Payment status is ambiguous (TA), starting polling...")
        console.log("AIRTEL Response: Data", data)
    
        console.log("AIRTEL Ref", data.ref);
        pollAirtelPaymentStatus(data.ref);
    } else {
        // Unknown status
        const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
        pendingModalInstance.hide();
        
        // alert('AIRTEL Payment status unknown: ' + (data.status || 'No status'));
        console.log("AIRTEL Unknown status:", data.status, data);
    }

  }).catch(error =>{

    console.error('Error calling /airtel-pay API:', error);
    // Hide pending modal on error
    const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
    if(pendingModalInstance) pendingModalInstance.hide();
    
    alert('There was an error processing your AIRTEL payment.');
  });

}

// Polling function for Airtel payment status
function pollAirtelPaymentStatus(ref) {
    const intervalId = setInterval(function () {
        fetch(`https://pay.yeshualifeug.com/airtel-status/${ref}`)
        .then(response => response.json())
        .then(data => {
            console.log('AIRTEL STATUS-PAY:', data.status);
            
            if (data.status === 'TS') {
                // TS = Transaction Success
                const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
                pendingModalInstance.hide();

                setTimeout(() => {
                    const successModal = new bootstrap.Modal(document.getElementById('exampleModalPush'));
                    successModal.show();
                }, 500);
                
                console.log("AIRTEL Payment processed successfully! (TS)")
                clearInterval(intervalId); 

            } else if (data.status === 'TF' || data.status === 'TE') {
                // TF = Transaction Failed, TE = Transaction Expired
                const pendingModalInstance = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
                pendingModalInstance.hide();
                
                clearInterval(intervalId); 
                alert("AIRTEL Payment failed: " + (data.message || (data.status === 'TF' ? 'Transaction Failed' : 'Transaction Expired')));

            } else if (data.status === 'TIP' || data.status === 'TA') {
                // TIP = Transaction in Progress, TA = Transaction Ambiguous
                console.log("AIRTEL Payment is still in progress (" + data.status + ")...");
                // Keep the pending modal showing and continue polling
            }
        })
        .catch(error => {
            console.error('Error polling AIRTEL payment status:', error);
        });
    }, 5000); // Poll every 5 seconds

    // Stop the polling after 60 seconds
    setTimeout(function () {
        clearInterval(intervalId);  // Stop polling after 60 seconds

        const pendingModal = bootstrap.Modal.getInstance(document.getElementById('pendingModalLong'));
        if (pendingModal) pendingModal.hide();

        const showsuccess = bootstrap.Modal.getInstance(document.getElementById('exampleModalPush'));
        if (showsuccess) showsuccess.show();
        
        console.log("AIRTEL Payment polling timed out after 60 seconds");
    }, 60000); // Timeout after 60 seconds
}

    
        });
    
    
  </script>
  {% endblock  %}