<!-- Modal -->
{% load static %}
{% load wagtailcore_tags wagtailimages_tags%}
{% block extra_css %}
<link href="{% static 'css/payment.css'%}" rel="stylesheet">
{% endblock  %}

<div class="modal fade" id="mtnModal" tabindex="-1" aria-labelledby="mtnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mtnModalLabel">MTN MOMO PAY</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="container bg-light d-md-flex align-items-center justify-content-center p-3">
               <form action="" method="post" id="payform">
                {% csrf_token %}
                <div class="card box2 shadow-sm m-3 ">
                    <div class="d-flex align-items-center justify-content-between p-md-5 p-4 mtn-background"> <span
                            class="h5 fw-bold m-0">MTN PAYMENT</span>
                        <div class="btn">
                            <img src="{% static 'images/New-mtn-logo.jpeg'%}"  alt="" height="40" width="40" srcset=""> 
                        </div>
                    </div>
                
                    <form action="" id="mtn-payment">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex flex-column px-md-5 px-4 mb-4"> <span>Donor Names</span>
                                    <div class="inputWithIcon"> 

                                        <input id="fullname"  class="form-control fw-light" type="text"
                                        value="Idaas" hidden>

                                        <input id="donorName"  class="form-control fw-light" type="text"
                                            value="500" disabled>

                                        </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column ps-md-5 px-md-0 px-4 mb-4"> <span>Donation<span
                                            class="ps-1">Amount</span></span>
                                    <div class="inputWithIcon"> 
                                        <input id="donationAmount" type="text" class="form-control" placeholder="500" disabled> <span
                                            class="fas fa-money-bill"></span> </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column pe-md-5 px-md-0 px-4 mb-4"> <span>Currency</span>
                                    <div class="inputWithIcon"> 
                                     <input id="currency" type="text" value="UGX" disabled>
                                        <span class="fas fa-lock"></span></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-column px-md-5 px-4 mb-4"> <span>Enter Phone:</span>
                                    <div class="inputWithIcon"> 
                        <input class="form-control text-uppercase" id="phoneid" name="phone" type="text"  placeholder="(0774-345-343)" style="font-size:11" >
                        <input id="message"  class="form-control fw-light" type="text"
                        value="testing" hidden>
                        <span class="far fa-user"></span></div>
                                </div>
                            </div>
                            <div class="col-12 px-md-5 px-4 mt-3">
                                <button id="my-button-mtn" class="btn btn-primary w-100" type="submit">Pay UGX 500.00</button>
                            </div>
                        </div>
                    </form>
                  
                </div>
               </form>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <!--  <button type="button" class="btn btn-primary">Save changes</button> -->
        </div>
      </div>
    </div>
  </div>

  <!--{% include "sections/pending.html" %}-->

  <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modelheader">

          <h5 class="modal-title fs-5 text-center" id="exampleModalLongTitle">Check Your phone !</h5>
          
        </div>
        <div class="modal-body">
          <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="75"  aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar bg-success" style="width: 75%">75%</div>
          </div>
         <p>There is a notification sent to your phone. complete the donation now!</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel this Payment</button>
          <button type="button" class="btn btn-success">I have Completed the payment</button>
        </div>
      </div>
    </div>
  </div>

  {% block extra_js %}
  <script>
      function showModalPending() {
          // Ensure this modal is correctly targeted
          var myModalPending = new bootstrap.Modal(document.getElementById('mtnModalPending'));
          myModalPending.show();  // Show the pending payment modal
      }
  
      function hideModal() {
          // Ensure you hide the current modal correctly
          var modal = new bootstrap.Modal(document.getElementById('mtnModal')); // Hide the first modal
          modal.hide();
      }
  
      document.addEventListener('DOMContentLoaded', function() {
          var mtnButton = document.getElementById("my-button-mtn"); // Assuming the ID for your button
          const modalElement = document.getElementById('mtnModal'); // The first modal you want to hide
          const modalPendingElement = document.getElementById('mtnModalPending'); // The pending modal element
          
          const modal = new bootstrap.Modal(modalElement);
          const modalPending = new bootstrap.Modal(modalPendingElement);
  
          console.log("DOM loaded and formData:", formData);
  
          var formData = JSON.parse(localStorage.getItem('formData')) || {}; // Fetch stored form data if any
          const form = document.getElementById("payform");
  
          mtnButton.addEventListener('click', function(event) {
              event.preventDefault();
              var number = document.getElementById("phoneid").value;  // Get phone number
              var msgPayment = document.getElementById("message").value;  // Get message
  
              console.log("Phone Number:", number);
              console.log("Message:", msgPayment);
  
              if (number === null || number.trim() === '') {
                  alert("Phone number can't be blank!");
                  return false;
              } else if (number !== '' && !number.match(/^\d{10,15}$/)) {
                  alert('Please enter a valid number.');
                  return false;
              } else {
                  // Prepare payment data and make API call
                  var mtnPayment = {
                      amount: document.getElementById('donationAmount').value,
                      currency: document.getElementById('currency').value,
                      fullname: document.getElementById('fullname').value,
                      message: document.getElementById('message').value,
                      phone: document.getElementById('phoneid').value,
                  };
  
                  console.log("Payment Data:", mtnPayment);

                  modal.hide(); // Hide main modal
  
                  var data = {
                      "amount": mtnPayment['amount'],
                      "currency": mtnPayment["currency"],
                      "txt_ref": "some_ref_value", // This is placeholder. Make sure to replace with the actual reference.
                      "phone_number": mtnPayment["phone"],
                      "payermessage": mtnPayment["message"]
                  };
  
                  console.log("Data to API:", data);
  
                  apiCall(data);
              }
          });
  
          function apiCall(data) {
              const url = "https://pay.yeshualifeug.com/pay";
  
              fetch(url, {
                  method: "POST",
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(data) // Send the data in the body
              })
                  .then(response => {
                      if (!response.ok) {
                          return Promise.reject("API call failed with status: " + response.status);
                      }
                      return response.json();  // Parse JSON response
                  })
                  .then(data => {
                      console.log('API Response:', data);
  
                      if (data.status === 'SUCCESSFUL') {
                          alert('Payment processed successfully!');
                          // Optionally, redirect or update the UI accordingly
                      } else if (data.status === 'FAILURE') {
                          alert('Payment failed: ' + data.message);
                          console.log('Payment failed:', data.message);
                      } else if (data.status === 'PENDING') {
                          alert('Payment is pending, please wait...');
                          console.log("Payment is pending, please wait...");
  
                         // hideModal(); // Hide the current modal
                         // showModalPending(); // Show the pending modal

                        
                         modalPending.show(); // Show pending modal
                          
                        //  pollPaymentStatus(data.ref); // Poll the payment status using the reference
                      }
                  })
                  .catch(error => {
                      console.error('Error calling /pay API:', error);
                      alert('There was an error processing your payment.');
                  });
          }
  
          function pollPaymentStatus(ref) {
              // Example polling function to check payment status every 5 seconds
              setInterval(function () {
                  fetch(`/status/${ref}`)
                      .then(response => response.json())
                      .then(data => {
                          if (data.status === 'SUCCESSFUL') {
                              alert("Payment was successful!");
                              // Update UI accordingly or redirect the user
                          } else if (data.status === 'FAILURE') {
                              alert("Payment failed: " + data.message);
                          } else if (data.status === 'PENDING') {
                              console.log("Payment is still pending, checking again...");
                          }
                      })
                      .catch(error => {
                          console.error('Error polling payment status:', error);
                      });
              }, 5000); // Poll every 5 seconds
          }
      });
  </script>
  {% endblock %}
  